<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
	<head>
		<title>iciql</title>
		<link rel="stylesheet" type="text/css" href="./iciql.css"/>
		<link rel="stylesheet" type="text/css" href="./markdown.css"/>
		<link rel="shortcut icon" type="image/png" href="./iciql-favicon.png" />
		<meta name="ROBOTS" content="INDEX">
		<meta http-equiv="imagetoolbar" content="no" />
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<meta name="keywords" content="java sql query jaqu" />
				
		<script type="text/javascript" src="prettify.js"></script>
		<link href="prettify.css" type="text/css" rel="stylesheet" />
						
		<!-- Place this tag in your head or just before your close body tag -->
		<script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>
				
		<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24377072-3']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

	</head>
	<body style="width:900px" onload="prettyPrint()">
		<a href="http://github.com/iciql><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://d3nwyuy0nl342s.cloudfront.net/img/30f550e0d38ceb6ef5b81500c64d970b7fb0f028/687474703a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6f72616e67655f6666373630302e706e67" alt="Fork me on GitHub"></a>
		<div class="page_header">
			<a title="iciql homepage" href="http://iciql.com/">
				<img src="./iciql.png" width="76" height="48" alt="iciql" class="logo"/>
			</a>
			<span style="color:black;">iciql</span>
			<!-- Google Plus One -->
			<g:plusone></g:plusone>
		</div>
		<div class="page_nav"><a href='index.html'>overview</a> | <a href='model_classes.html'>model classes</a> | <a href='table_versioning.html'>versioning</a> | <a href='usage.html'>usage</a> | <a href='performance.html'>performance</a> | <a href='examples.html'>examples</a> | <a href='tools.html'>tools</a> | <a href='building.html'>building</a> | <a href='javadoc.html'>javadoc</a> | <a href='releases.html'>releases</a> | <a href='jaqu_comparison.html'>jaqu comparison</a></div>
		<div class="markdown">
<h2> Usage</h2>

<p>Aside from this brief usage guide, please consult the <a href="examples.html">examples</a>, the <a href="javadoc.html">javadoc</a> and the <a href="https://code.google.com/p/iciql/source/browse">source code</a>.</p>

<h3> Instantiating a Db</h3>

<p>Use one of the static utility methods to instantiate a Db instance:</p>

<pre><code>Db.open(String url, String user, String password);
Db.open(String url, String user, char[] password);
Db.open(Connection conn);
Db.open(DataSource dataSource);
</code></pre>

<h3> Compile-Time Statements</h3>

<p>You compose your statements using the builder pattern where each method call returns an object that is used to specify the next part of the statement.  Through clever usage of generics, pioneered by the original JaQu project, compile-time safety flows through the statement.</p>

<p><pre class='prettyprint lang-java'>
Db db = Db.open("jdbc:h2:mem:", "sa", "sa");
db.insertAll(Product.getList());
db.insertAll(Customer.getList());

List&lt;Product&gt; restock =
	db.from(p).
	where(p.unitsInStock).
	is(0).orderBy(p.productId).select();
		
for (Product product : restock) {
	db.from(p).
	set(p.unitsInStock).to(25).
	where(p.productId).is(product.productId).update();
}
db.close();
</pre></p>

<p>Please see the <a href="examples.html">examples</a> page for more code samples. </p>

<h3> Dynamic Runtime Queries</h3>

<p>Iciql gives you compile-time type-safety, but it becomes inconvenient if your design requires more dynamic statement generation.  For these scenarios iciql offers some runtime query support through a hybrid approach or a pure JDBC approach.</p>

<h4> Where String Fragment Approach</h4>

<p>This approach is a mixture of iciql and jdbc.  It uses the traditional prepared statement <em>field=?</em> tokens with iciql compile-time model class type checking.  There is no field token type-safety checking.
<pre class='prettyprint lang-java'>
List&lt;Product&gt; restock = db.from(p).where("unitsInStock=? and productName like ? order by productId", 0, "Chef%").select();
</pre></p>

<h4> Db.executeQuery Approaches</h4>

<p>There may be times when the hybrid approach is still too restrictive and you'd prefer to write straight SQL.  You can do that too and use iciql to build objects from your ResultSet, but be careful:</p>

<ol>
<li>Make sure to <em>select *</em> in your query otherwise db.buildObjects() will throw a RuntimeException</li>
<li>There is no model class type checking nor field type checking. </li>
</ol>

<p><pre class='prettyprint lang-java'>
List&lt;Product&gt; allProducts = db.executeQuery(Product.class, "select * from products");
List&lt;Product&gt; restock = db.executeQuery(Product.class, "select * from products where unitsInStock=?", 0);

// parameterized query which can be cached and re-used later
String q = db.from(p).where(p.unitsInStock).isParameter().toSQL();
List&lt;Product&gt; restock = db.executeQuery(Product.class, q, 0);

</pre> </p>

<p>Or if you want access to the raw <em>ResultSet</em> before building your model object instances...</p>

<p><pre class='prettyprint lang-java'>
ResultSet rs = db.executeQuery("select * from products");
List&lt;Product&gt; allProducts = db.buildObjects(Product.class, rs);
// This method ensures the creating statement is closed
JdbcUtils.closeSilently(rs, true);
</pre> </p>

<h3> Natural Syntax</h3>

<span class="warning">work-in-progress</span>
<p>The original JaQu source offers partial support for Java expressions in <em>where</em> clauses.</p>

<p>This works by decompiling a Java expression, at runtime, to an SQL condition.  The expression is written as an anonymous inner class implementation of the <code>com.iciql.Filter</code> interface.
A proof-of-concept decompiler is included, but is incomplete.</p>

<p>The proposed syntax is:
<pre class='prettyprint lang-java'>
long count = db.from(co).
    where(new Filter() { public boolean where() {
        return co.id == x
            &amp;&amp; co.name.equals(name)
            &amp;&amp; co.value == new BigDecimal("1")
            &amp;&amp; co.amount == 1L
            &amp;&amp; co.birthday.before(new java.util.Date())
            &amp;&amp; co.created.before(java.sql.Timestamp.valueOf("2005-05-05 05:05:05"))
            &amp;&amp; co.time.before(java.sql.Time.valueOf("23:23:23"));
        }
    }).selectCount();
</pre></p>

<h3> JDBC Statements, ResultSets, and Exception Handling</h3>

<p>Iciql opens and closes all JDBC objects automatically.  SQLExceptions thrown during execution of a statement (except for <em>close()</em> calls), will be caught, wrapped, and rethrown as an <code>IciqlException</code>, which is a RuntimeException.</p>

<p>Iciql does not throw any <a href="http://en.wikipedia.org/wiki/Exception_handling#Checked_exceptions">checked exceptions</a>.</p>

<h3> Statement Logging</h3>

<p>Iciql provides a mechanism to log generated statements and warnings to the console, to SLF4J, or to your own logging framework.  Exceptions are not logged using this mechanism; exceptions are wrapped and rethrown as <code>IciqlException</code>, which is a RuntimeException.</p>

<h4> Console Logging</h4>

<p><pre class='prettyprint lang-java'>
IciqlLogger.activeConsoleLogger();
IciqlLogger.deactiveConsoleLogger();
</pre></p>

<h4> SLF4J Logging</h4>

<p><pre class='prettyprint lang-java'>
Slf4jIciqlListener slf4j = new Slf4jIciqlListener();
slf4j.setLevel(StatementType.CREATE, Level.WARN);
slf4j.setLevel(StatementType.DELETE, Level.WARN);
slf4j.setLevel(StatementType.MERGE, Level.OFF);
IciqlLogger.registerListener(slf4j);
IciqlLogger.unregisterListener(slf4j);
</pre></p>

<h4> Custom Logging</h4>

<p><pre class='prettyprint lang-java'>
IciqlListener custom = new IciqlListener() {
    public void logIciql(StatementType type, String statement) {
        // do log
    }
};
IciqlLogger.registerListener(custom);
IciqlLogger.unregisterListener(custom);
</pre></p>

<h2> Understanding Aliases and Model Classes</h2>

<p>Consider the following example:
<pre class='prettyprint lang-java'>
Product p = new Product();
List&lt;Product&gt; restock = db.from(p).where(p.unitsInStock).is(0).select();
</pre></p>

<p>The Product model class instance named <strong>p</strong> is an <em>alias</em> object.  An <em>alias</em> is simply an instance of your model class that is only used to build the compile-time/runtime representation of your table.</p>

<ol>
<li><em>Alias</em> instances are <strong>NOT</strong> thread-safe and must not be used concurrently.</li>
<li><em>Alias</em> instances have no other purpose than to provide a compile-time/runtime map of your table.</li>
<li>If you inspected an <em>alias</em> instance after using one you would find that it's fields have been assigned numeric values.<br/>These values are assigned from a static counter in <code>com.iciql.Utils.newObject()</code> during execution of the <em>db.from()</em> method.<p>For <em>Object</em> fields, these values are meaningless since objects are mapped by reference.<br/>For <em>Primitive</em> fields these values do matter because primitives are mapped by value.  The proper alias is selected as long as the primitive variant methods are used.  e.g. db.from(p).where(int).is(Integer).select()</li>
</ol>

<p>If your statement is a query, like in the above example, iciql will generate new instances of your <em>alias</em> model class and return them as a list where each entry of the list represents a row from the JDBC <code>ResultSet</code>.</p>

<h3> Why are Aliases not thread-safe?</h3>

<p>The <em>db.from(p)</em> call reinstantiates each member field of p.  Those reinstantiated fields are then subsequently used in clauses like <em>where(p.unitsInStock)</em>.  If your <em>alias</em> instance is shared concurrently then its highly probable that when <em>queryA</em> executes, <em>queryC</em> has reinstantiated all the <em>alias</em> fields and broken <em>queryA's</em> runtime field mapping.</p>

<p>Depending on your design, you might consider using a <a href="http://download.oracle.com/javase/6/docs/api/java/lang/ThreadLocal.html">ThreadLocal</a> variable if you do not want to keep instantiating <em>alias</em> instances.  A utility function is included for easily creating ThreadLocal variables.</p>

<p><pre class='prettyprint lang-java'>
final ThreadLocal&lt;Product&gt; p = Utils.newThreadLocal(Product.class);
db.from(p.get()).select();
</pre></p>

<h2> Best Practices</h2>

<ol>
<li>Close your <em>Db</em> instances when you are done with them, this closes the underlying connection or directs the pool to &quot;close&quot; the connection.</li>
<li>Aliases instances are not thread-safe so DO NOT SHARE an alias!<br/>Consider using a <em>ThreadLocal</em> alias instance with the <code>com.iciql.Utils.newThreadLocal()</code> utility method.
<table>
<tr><th>Not Thread-Safe</th><th>Thread-Safe</th></tr>
<tr><td>
<pre class='prettyprint lang-java'>
final Product p = new Product();
for (int i = 0; i < 5; i++) {
    Thread thread = new Thread(new Runnable() {
        public void run() {
            // from(p) reinstantiates p's fields
            db.from(p).select();
        }
    }, "Thread-" + i);
    thread.start();
}
</pre>
</td><td>
<pre class='prettyprint lang-java'>
final ThreadLocal&lt;Product&gt; p = Utils.newThreadLocal(Product.class);
for (int i = 0; i < 5; i++) {
    Thread thread = new Thread(new Runnable() {
        public void run() {
            // p.get() returns a Product instance unique to this thread            
            db.from(p.get()).select();
        }
    }, "Thread-" + i);
    thread.start();
}
</pre>
</td></tr>
</table></li>
</ol>	</div>
	<div style="margin-top:10px" class="page_footer">
		<div style="float:right;">generated 2012-01-11</div>
	The content of this page is licensed under the <a href="http://creativecommons.org/licenses/by/3.0">Creative Commons Attribution 3.0 License</a>.
	</div>
</body>
</html>
